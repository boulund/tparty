# TTT automated proteotyping pipeline

## 0. RAW to mzXML conversion [raw2mzxml]
ThermoFischer raw (*.raw) files are converted to mzXML using ReAdW (2015.1.0)
running via Wine (1.6.1) under Red Hat Enterprise Linux Server 6.6. 
The command line for file conversion is equivalent to:

    wine ReAdW.exe --nocompress --gzip $RAWFILE $MZXMLFILE

A bash script finds new raw files in `/collaborator/TTT/raw` that haven't
already been converted and runs ReAdW to convert them in parallel using GNU
Parallel. The finished mzXML files are stored in
`/storage/boulund/TTT/mzXML/`.

Several times daily, the bash script to convert new raw files in
`/collaborator/TTT/raw/` is automatically run by way of a crontab entry:

    0 8,12,15,17,20,22 * * * /bin/bash /home/boulund/research/TTT/code/TTT_proteotyping_pipeline/convert_raw_files_to_mzxml.sh /collaborator/TTT/raw /storage/boulund/TTT/mzXML/


## 1. Peptide identification from spectra using X!!Tandem [peptides]
The mass spectra stored in the mzXML files are "converted" to peptide sequences
using X!!Tandem (a parallel implementation av X!Tandem).
The command line for X!!Tandem is equivalent to:

    mpirun -n $N tandem.exe $INPUTXML

where `$N` is the number of processes to use, and `$INPUTXML` is the path to an
XML file generated for each input mzXML that specifies all the required
settings for running X!!Tandem.

X!!Tandem requires three XML files to run (`taxonomy.xml`, `default_input.xml`, and
`input_sample.xml`). The three files are generated by the script that runs
X!!Tandem, and all pertitent X!!Tandem settings are thus stored inside the
script that runs X!!Tandem.
The reference database that is used for peptide matching is constructed from
all peptides from the Human Microbiome Project (`all_pep_20141006.tar.gz`), all
sequences from the reference genomes from the Human Microbiome Project
(`hmp_reference_genomes.fasta`), and a filtered version of NCBI GenBank NR
where all sequences with X in them have been removed (`nr_nox.fasta`). The
database file used for X!!Tandem matching is located at:
`/storage/boulund/TTT/ms_refdb/ms_refdb.fasta`.

The peptide identification is performed by `run_xtandem.py`, which is
controlled by the Snakemake script.


### 1.1 Human peptides
X!!Tandem is run again to identify potential human peptides in each sample.
Everything works as described in [peptides][], except the database used is the
human proteome downloaded from UniProt 
(`/storage/boulund/TTT/ms_refdb/human_proteome_UP000005640.fasta`).

The human peptide search is run via `run_xtandem.py`, controlled by the
Snakemake script.


### 1.2 Unique protein lists
After X!!Tandem finishes, a script is run to find all unique proteins occuring in the
bacterial and human X!!Tandem peptide output. 

The unique protein reports are generated via `create_unique_protein_lists.py`,
which is controlled by the Snakemake script.



## 2. Find matches to reference genomes using BLAT [blat]
All bacterial peptides produced by X!!Tandem are searched against a database of
reference genome sequences using BLAT (or pBLAT).  The command line for BLAT
searches is equivalent to: 

    blat $REFDB $INPUTFILE -out=blast8 -t=dnax -q=prot -tileSize=5 -stepSize=5 -minScore=10 -minIdentity=85 $OUTPUTFILE

where `$REFDB` is a FASTA file containing all reference genome sequences,
`$INPUTFILE` is the sample FASTA file produced by X!!Tandem in the previous
step, and `$OUTPUTFILE` is where mapping results are written in blast tabular
format.

BLAT is run by `run_blat.py`, which is controlled by the Snakemake script.



## 3. Proteotyping
The peptide matches to the reference genome sequences are used to perform the
actual proteotyping. The proteotyping workflow is performed by `proto.py`, and
is controlled by the Snakemake script.
